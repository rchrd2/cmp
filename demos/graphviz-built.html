<html><head><meta charset="UTF-8">
  
  <!-- <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script> -->
  <!-- <link rel="import" href="../components/x-css-reset/x-css-reset.html"> -->
  <!-- <link rel="import" href="../components/x-css-normalize/x-css-normalize.html"> -->
  <!-- <link rel="import" href="../components/x-state/x-state.html"> -->
  
  
  
  
  
  <style>
*, *:before, *:after { box-sizing: border-box; }
html, body { height:100%; }
body {margin:0; padding:0;}
#app {
  display: flex;
  flex-direction: column;
  height:100%;
}
x-panes {
  flex: 1;
  /*background-color: grey;*/
}
#code-pane {
  /*max-width: 30rem; */
  resize: horizontal;
}
#codearea { width:100%; border:0; padding: 5rem;}
#viz-pane {
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  align-content:top;
  align-items:center;
  border:none;
  overflow-y: scroll;
}
#viz-pane svg, #viz-pane img {
  margin-top: 30px;
  /*max-width:100%;*/
}
x-controlbar > content > select {
  width: 40px;
}
/* firefox selector */
@supports (-moz-appearance:none) and (display:contents) {
  x-controlbar > content > select {
    width: 70px;
  }
}
  </style>
</head>
<body><script>
  /* Only load webcomponent-lite polyfill when needed */
  var webComponentsSupported = ('registerElement' in document
    && 'import' in document.createElement('link')
    && 'content' in document.createElement('template'));
  if (!webComponentsSupported) {
    var wcPoly = document.createElement('script');
    wcPoly.src = '../bower_components/webcomponentsjs/webcomponents-lite.js';
    document.head.appendChild(wcPoly);
  }
  </script><div hidden="" by-vulcanize=""><style>
x-panes * { box-sizing: border-box; margin: 0; }
x-panes {
  display: flex;
  flex-direction:column;
}
x-panes content {
  flex:1;
  width:100%;
  display:flex;
  flex-direction:row;
  justify-content:space-around;
}
x-panes content div {
  border:1px solid #ccc;
  width:100%;
  display:flex;
  /*height:100%;*/

  /*margin:0;
  height:100%;
  padding:6px;
  margin-left:6px;*/
}
x-panes content div:first-child {
  margin-left:0;
}
</style>

<template>
  <content></content>
</template>


<script>
(function(window, document, undefined) {
  var thisDoc = (document._currentScript || document.currentScript).ownerDocument;
  var El = Object.create(HTMLElement.prototype);

  El.loadTemplate = function() {
    var template = thisDoc.querySelector('template').content;
    var clone = document.importNode(template, true);
    // Move children into <content> tag
    var content = clone.querySelectorAll('content')[0] || undefined;
    if (content) {
      while (this.childNodes.length) {
        content.appendChild(this.firstChild);
      }
    }
    this.innerHTML = "";
    this.appendChild(clone);
  }

  El.createdCallback = function() {
    this.loadTemplate();
  };
  El.attributeChangedCallback = function(attr, oldVal, newVal) {
  };
  window.XPanesElement = document.registerElement('x-panes', {
    prototype: El
  });
})(window, document);
</script></div><div hidden="" by-vulcanize="">
<script>
/**
 * Just a text area with some styles for code
 */
(function(window, doc, undefined) {
  var thisDoc =  (doc._currentScript || doc.currentScript).ownerDocument;
  var ElProto = Object.create(HTMLTextAreaElement.prototype);
  ElProto.createdCallback = function() {
    this.style.fontFamily = "Menlo, monospace";
    this.style.padding = "4px";
    this.style.resize = "none";
    this.style.outline = "none";
    this.style.fontSize = "12px";
    this.style.lineHeight = "14px";
    this.style.whiteSpace = "pre";
    this.style.wordWrap = "normal";
    this.style.overflowX = "scroll";
  };
  window.MyElement = doc.registerElement('x-codearea', {
    prototype: ElProto,
    extends: 'textarea'
  });
})(window, document);
</script></div><div hidden="" by-vulcanize="">

<script src="../components/x-viz/viz.js"></script><script>
(function(window, document, undefined) {
  var thisDoc =  (document._currentScript || document.currentScript).ownerDocument;
  var ElProto = Object.create(HTMLElement.prototype);

  // @see http://shebang.brandonmintern.com/foolproof-html-escaping-in-javascript/
  function unescapeHtml(s) {
    var MAP = {
      '&amp;': '&',
      '&lt;': '<',
      '&gt;': '>',
      '&quot;': '"',
      '&#39;': "'"
    };
    for (var key in MAP) {
      s = s.replace(new RegExp(key, 'g'), MAP[key]);
    }
    return s;
  }


  ElProto.createdCallback = function() {
    this.updateGraph();
  };
  ElProto.updateGraph = function() {
    var gv = this.getAttribute("value") || "";
    gv = unescapeHtml(gv);
    console.log(gv);
    var engine = this.getAttribute("engine") || "dot";
    var format = this.getAttribute("format") || "svg";
    var result;
    if (gv !== "") {
      try {
        // gv = gv + "\n# random comment " + Math.random();
        result = Viz(gv, {format: format, engine: engine});
      } catch (err) {
        console.log(err);
        alert('There was an error rendernig the graph. You may need to reload the page');
      }
    }
    if (result && format === "png-image-element") {
      this.innerHTML = "";
      this.appendChild(result);
    } else if (result && format === "svg") {
      this.innerHTML = result;
    } else {
      this.innerHTML = "<pre>" + result + "</pre>";
    }
  };
  ElProto.attributeChangedCallback = function(attr, oldVal, newVal) {
    // if (attr == "value" && oldVal !== newVal) {
      this.updateGraph();
    // }
  };
  window.XVizElement = document.registerElement("x-viz", {
    prototype: ElProto,
  });
})(window, document);
</script></div><div hidden="" by-vulcanize=""><style>
  x-controlbar {
    background-color:#ccc;
    display:block;
    padding: 0.0625rem 1rem;
  }
  x-controlbar content > select {
    border:1px solid transparent;
    border-radius:0;
    background-color:transparent;
    margin:0;
    color: #333;
    -webkit-appearance: none;
    outline:none; /* remove focus ring from Webkit */
  }
  x-controlbar content > select, x-controlbar content > span {
    margin: 0 1.0rem 0 0;
  }
</style>

<template>
  <content></content>
</template>


<script>
(function(window, document, undefined) {
  var thisDoc =  (document._currentScript || document.currentScript).ownerDocument;
  var ElProto = Object.create(HTMLElement.prototype);

  ElProto.loadTemplate = function() {
    var template = thisDoc.querySelector('template').content;
    var clone = document.importNode(template, true);
    var content = clone.querySelector('content');
    while (content && this.childNodes.length) {
      content.appendChild(this.firstChild);
    }
    // this.innerHTML = "";
    this.appendChild(clone);
  }

  var resolve = function(path, obj, safe) {
    return path.split('.').reduce(function(prev, curr) {
        return !safe ? prev[curr] : (prev ? prev[curr] : undefined)
    }, obj || self)
  };

  /**
   * Call the on-click value with value as argument
   */
  var handleSelectChange = function(select) {
    var option = select.options[select.selectedIndex];
    var callbackName = option.getAttribute('on-click');
    var first = select.querySelector('option');
    select.value = first.value;
    if (callbackName) {
      var callback = resolve(callbackName, window, true);
      if (callback) {
        callback(option.value);
      }
    }
  };

  ElProto.createdCallback = function() {
    this.loadTemplate();
    var selects = this.querySelectorAll('select');
    for (var i = 0; i < selects.length; i++) {
      selects[i].onchange = function(e) {
        handleSelectChange(e.target);
      };
    }
  };
  ElProto.attributeChangedCallback = function(attr, oldVal, newVal) {
    if (attr == "value" && oldVal !== newVal) {
    }
  };
  window.XControlbarElement = document.registerElement("x-controlbar", {
    prototype: ElProto,
  });
})(window, document);
</script></div><div hidden="" by-vulcanize="">
<script src="../components/x-yaml/js-yaml.min.js"></script></div><div id="app">
    <x-controlbar>
      <span>â€”</span>
      <select name="select">
        <option value="" selected="">Syntax</option>
        <option value="graphviz" on-click="handleSyntaxChange">Graphviz</option>
        <option value="yaml" on-click="handleSyntaxChange">YAML</option>
      </select>
      <select name="select">
        <option value="" selected="">Engine</option>
        <option value="circo" on-click="handleEngineChange">circo</option>
        <option value="dot" on-click="handleEngineChange">dot</option>
        <option value="fdp" on-click="handleEngineChange">fdp</option>
        <option value="neato" on-click="handleEngineChange">neato</option>
        <option value="osage" on-click="handleEngineChange">osage</option>
        <option value="twopi" on-click="handleEngineChange">twopi</option>
      </select>
      <select name="select">
        <option value="" selected="">Format</option>
        <option value="svg" on-click="handleFormatChange">svg</option>
        <option value="png-image-element" on-click="handleFormatChange">png</option>
        <option value="xdot" on-click="handleFormatChange">xdot</option>
        <option value="plain" on-click="handleFormatChange">plain</option>
        <option value="ps" on-click="handleFormatChange">ps</option>
      </select>
    </x-controlbar>
    <x-panes>
      <div id="code-pane">
        <textarea id="codearea" is="x-codearea">digraph g {
  a -&gt; b;
  c -&gt; d;
  d -&gt; a;
  b -&gt; c;
}
</textarea>
      </div>
      <div id="viz-pane">
        <x-viz id="x-viz" value="" engine="circo" format="png-image-element"></x-viz>
      </div>
    </x-panes>
  </div>
  <script>


// @see https://davidwalsh.name/javascript-debounce-function
function debounce(func, wait, immediate) {
	var timeout;
	return function() {
		var context = this, args = arguments;
		var later = function() {
			timeout = null;
			if (!immediate) func.apply(context, args);
		};
		var callNow = immediate && !timeout;
		clearTimeout(timeout);
		timeout = setTimeout(later, wait);
		if (callNow) func.apply(context, args);
	};
}


// Include MicroEvent library inline
var MicroEvent = function(){};
MicroEvent.prototype	= {
	bind: function(event, fct){
		this._events = this._events || {};
		this._events[event] = this._events[event]	|| [];
		this._events[event].push(fct);
	},
	unbind: function(event, fct){
		this._events = this._events || {};
		if( event in this._events === false  )	return;
		this._events[event].splice(this._events[event].indexOf(fct), 1);
	},
	trigger: function(event /* , args... */){
		this._events = this._events || {};
		if( event in this._events === false  )	return;
		for(var i = 0; i < this._events[event].length; i++){
			this._events[event][i].apply(this, Array.prototype.slice.call(arguments, 1));
		}
	}
};
MicroEvent.mixin = function(destObject){
	var props	= ['bind', 'unbind', 'trigger'];
	for(var i = 0; i < props.length; i ++){
		if( typeof destObject === 'function' ){
			destObject.prototype[props[i]]	= MicroEvent.prototype[props[i]];
		}else{
			destObject[props[i]] = MicroEvent.prototype[props[i]];
		}
	}
	return destObject;
}


/**
 * Converts from yaml to graphviz format
 * @param {string} value
 * @return {string} returns converted syntax or empty string on error
 * @author Richard Caceres
 */
function yaml2Gv(value) {
  var quote = function(s) {
    return '"' + s.replace('"', '\\"') + '"';
  };
  var edge_str = function(a, b) {
    if (b !== undefined) {
      return quote(a) + " -> " + quote(b);
    } else {
      return quote(a);
    }
  };
  var get_edges = function(name, children) {
    var edges = [];
    edges.push(edge_str(name));
    for (var i = 0; i < children.length; i++) {
      if (typeof children[i] === "string") {
        edges.push(edge_str(name, children[i]));
      } else {
        var key = Object.keys(children[i])[0];
        edges.push(edge_str(name, key));
        edges = edges.concat(get_edges(key, children[i][key]));
      }
    }
    return edges;
  };
  var edges = [];
  var doc;
  try {
    doc = jsyaml.safeLoad(value);
    for (name in doc) {
      edges = edges.concat(get_edges(name, doc[name]))
    };
    var gv = "digraph g {\n" + edges.join(";\n") + "\n" +
             "node[shape=rectangle];" +
             //"rankdir=LR;" +
             "splines=false;" +
             "}";
    return gv;
  } catch (err) {
    console.log(err);
    return ''
  }
}

//----

var ST = {
  text: '',
  syntax: 'graphviz',
  engine: 'dot',
  format: 'svg', // 'png-image-element',
};
MicroEvent.mixin(ST);

function handleSyntaxChange(value) {
  ST.syntax = value;
  var defaultValue;
  if (value === "yaml") {
    defaultValue = '"hello world": \n  - "lorum"';
  } else {
    defaultValue = 'digraph g {\n  a -> b;\n}';
  }
  ST.text = defaultValue;
  document.getElementById('codearea').value = defaultValue;
  ST.trigger('change');
}

function handleEngineChange(value) {
  ST.engine = value;
  ST.trigger('change');
}

function handleFormatChange(value) {
  ST.format = value;
  ST.trigger('change');
}

function updateViz(value, engine, format, syntax) {
  if (syntax === 'yaml') {
    value = yaml2Gv(value);
  }
  document.getElementById('x-viz').setAttribute('engine', engine);
  document.getElementById('x-viz').setAttribute('format', format);
  document.getElementById('x-viz').setAttribute('value', value);
}
// updateVizDebounced = debounce(updateViz, 800, false);

var updateTextDebounced = debounce(function(value){
  ST.text = value;
  ST.trigger('change');
}, 800, false);

document.getElementById('codearea').onkeyup = function(e) {
  updateTextDebounced(e.target.value);
}

function initState() {
  // Init from textarea
  ST.text = document.getElementById('codearea').value;

  // Bind changes
  ST.bind('change', function() {
    updateViz(ST.text, ST.engine, ST.format, ST.syntax);
  });

  window.ST = ST;
}

function ready() {
  initState();
  updateViz(ST.text, ST.engine, ST.format, ST.syntax);
}
ready();
  </script>


</body></html>